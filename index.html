<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BIG大特會 | 掃描開始</title>
    <meta name="description" content="掃描 QR Code 進入活動頁面" />
    <style>
      :root { --muted:#94a3b8; --text:#e5e7eb; }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, PingFang TC, Microsoft JhengHei, sans-serif;
        background: linear-gradient(180deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('./image/background.jpg') center/cover no-repeat fixed;
        color: var(--text);
        min-height: 100vh; display: grid; place-items: center; padding: 24px;
      }
      .container { width: 100%; max-width: 1400px; height: 100%; min-height: 84vh; display: grid; place-items: center; position: relative; }
      .brand { position: fixed; left: 16px; top: 16px; cursor: pointer; }
      .brand img { width: clamp(180px, 28vw, 420px); height:auto; filter: drop-shadow(0 6px 24px rgba(0,0,0,0.45)); }
      .controls { position: fixed; right: 16px; top: 16px; display:flex; gap: 8px; }
      button.switch, button.leaderboard { background: rgba(255,255,255,0.06); color: var(--text); border: 1px solid rgba(255,255,255,0.14); border-radius: 8px; padding: 8px 10px; font-size: 14px; cursor: pointer; opacity:.65 }
      button.switch.active { opacity: .95; }
      #qrcode { width: clamp(360px, 56vmin, 840px); height: clamp(360px, 56vmin, 840px); display: grid; place-items: center; background: rgba(0,0,0,0.2); border-radius: 16px; }
      .note { position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px; color: var(--text); font-size: clamp(18px, 3.2vw, 28px); text-align: center; opacity:.95; text-shadow: 0 2px 12px rgba(0,0,0,.45); }
      .link { margin-top: 8px; }
      .link a { color: #60a5fa; text-decoration: none; font-size: 14px; }
      .link a:hover { text-decoration: underline; }
      .corner-logo { position: fixed; right: 16px; bottom: 16px; width: clamp(48px, 14vw, 92px); height: auto; opacity: .95; }
      .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; padding: 8px; z-index: 50; }
      .modal { background: rgba(17,24,39,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; max-width: 1200px; width: 98vw; max-height: 94vh; display: grid; grid-template-rows: auto 1fr auto; overflow: hidden; }
      .modal header { padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.08); }
      .modal h3 { margin: 0; font-size: 20px; }
  .modal .content { overflow: auto; }
  .columns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 12px; }
  .block { border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; overflow: hidden; background: rgba(255,255,255,0.03); }
  .block h4 { margin: 0; padding: 8px 10px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.08); color: var(--muted); }
  .modal table { width: 100%; border-collapse: collapse; table-layout: fixed; }
      .modal th, .modal td { padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 13px; text-align: left; }
      .modal th:nth-child(1), .modal td:nth-child(1) { width: 70%; }
      .modal th:nth-child(2), .modal td:nth-child(2) { width: 30%; text-align: right; }
      .modal .footer { padding: 8px 12px; display: flex; gap: 8px; justify-content: flex-end; }
      .close-btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); color: var(--text); padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="brand" id="brand">
        <img src="./image/BIG大特會-white.png" alt="BIG大特會" title="點擊清除排行榜與裝置紀錄（僅限遊戲）" />
      </div>
      <div class="controls">
        <button id="btnVerse" class="switch active" type="button">文</button>
        <button id="btnQuiz" class="switch" type="button">題</button>
        <button id="btnLeaderboard" class="leaderboard" type="button">分</button>
      </div>
      <div id="qrcode"></div>
      <div class="link" id="fallbackLink" style="display:none"></div>
      <div class="note">請用手機掃描上方 QR</div>
      <img class="corner-logo" src="./image/topchurchlogo.png" alt="Top Church" />
    </div>

    <script src="./scripts/supabase-config.js"></script>
    <script type="module">
      window.addEventListener('DOMContentLoaded', async () => {
      const { getSupabase } = await import('./scripts/supabase-client.js');
      // Build both targets with cache-busting version
      const base = location.origin + location.pathname.replace(/index\.html?$/, '');
      const sp = new URLSearchParams(location.search);
      const ver = sp.get('v') || (()=>{ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}`; })();
      const targets = { verse: `${base}view.html?v=${encodeURIComponent(ver)}`, quiz: `${base}quiz.html?v=${encodeURIComponent(ver)}` };

      const box = document.getElementById('qrcode');
      const linkWrap = document.getElementById('fallbackLink');
      const btnVerse = document.getElementById('btnVerse');
      const btnQuiz = document.getElementById('btnQuiz');
      const btnLeaderboard = document.getElementById('btnLeaderboard');

      const LS_KEY = 'rs_qr_mode_v1';
      let mode = localStorage.getItem(LS_KEY) || 'verse';

      function renderQR(target) {
        box.innerHTML = '';
        linkWrap.style.display = 'none';
        const size = Math.min(box.clientWidth, box.clientHeight) || 400;
        const img = new Image();
        img.alt = 'Scan QR to open';
        img.width = size; img.height = size;
        img.referrerPolicy = 'no-referrer';
        img.src = `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${encodeURIComponent(target)}&choe=UTF-8`;
        img.onerror = () => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
          script.onload = () => { try { box.innerHTML=''; new QRCode(box,{ text:target, width:size, height:size, correctLevel: QRCode.CorrectLevel.M }); } catch { showLink(target); } };
          script.onerror = () => showLink(target);
          document.head.appendChild(script);
        };
        box.appendChild(img);
      }

      function applyMode() {
        if (mode === 'quiz') {
          btnQuiz.classList.add('active'); btnVerse.classList.remove('active'); renderQR(targets.quiz);
        } else {
          btnVerse.classList.add('active'); btnQuiz.classList.remove('active'); renderQR(targets.verse);
        }
      }
      btnVerse.onclick = () => { mode = 'verse'; localStorage.setItem(LS_KEY, mode); applyMode(); };
      btnQuiz.onclick = () => { mode = 'quiz'; localStorage.setItem(LS_KEY, mode); applyMode(); };

      function showLink(target) { try { box.innerHTML=''; } catch{} linkWrap.style.display='block'; linkWrap.innerHTML = `若 QR 未顯示，請點此開啟：<a href="${target}">${target}</a>`; }

      // Leaderboard modal logic (same as before)
  const backdrop = document.getElementById('modalBackdrop');
    const col1 = document.getElementById('lbCol1');
    const col2 = document.getElementById('lbCol2');
    const col3 = document.getElementById('lbCol3');
    const pageInfo = document.getElementById('lbPage');
  let lbData = []; let page = 1; const blocksPerPage = 3; const blockSize = 50;
      async function loadLeaderboard() {
        const supa = await getSupabase();
        if (supa) {
          const { data, error } = await supa.from('leaderboard').select('name,score').order('score', { ascending:false }).limit(1000);
          if (!error && Array.isArray(data)) return data;
        }
        // fallback static file
        try { const r = await fetch('./leaderboard.json?v='+encodeURIComponent(ver)); if (r.ok) return await r.json(); } catch {}
        return [];
      }
      async function openLeaderboard() {
        backdrop.style.display='flex';
        box.style.display = 'none';
        if (!lbData.length) { lbData = await loadLeaderboard(); renderLB(); } else { renderLB(); }
      }
      function closeLeaderboard(){ backdrop.style.display='none'; box.style.display = 'grid'; }
      function renderTable(rows){
        return rows.length
          ? `<table><thead><tr><th>玩家</th><th>分數</th></tr></thead><tbody>${rows.map(it=>`<tr><td>${escapeHtml(it.name||'')}</td><td style="text-align:right">${it.score||0}</td></tr>`).join('')}</tbody></table>`
          : '<div style="padding:8px 10px;color:var(--muted)">暫無資料</div>';
      }
      function renderLB(){
        lbData.sort((a,b)=>(b.score||0)-(a.score||0));
        const total = lbData.length; const pages = Math.max(1, Math.ceil(total/(blocksPerPage*blockSize))); page = Math.min(Math.max(1,page), pages);
        const base = (page-1) * blocksPerPage * blockSize;
        const b1 = lbData.slice(base, base+blockSize);
        const b2 = lbData.slice(base+blockSize, base+2*blockSize);
        const b3 = lbData.slice(base+2*blockSize, base+3*blockSize);
        col1.innerHTML = `<div class="block"><h4>${b1.length? `${base+1}-${base+b1.length}`: '—'}</h4>${renderTable(b1)}</div>`;
        col2.innerHTML = `<div class="block"><h4>${b2.length? `${base+blockSize+1}-${base+blockSize+b2.length}`: '—'}</h4>${renderTable(b2)}</div>`;
        col3.innerHTML = `<div class="block"><h4>${b3.length? `${base+2*blockSize+1}-${base+2*blockSize+b3.length}`: '—'}</h4>${renderTable(b3)}</div>`;
        pageInfo.textContent = pages > 1 ? `第 ${page} / ${pages} 頁（共 ${total} 人）` : `共 ${total} 人`;
      }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

      document.getElementById('lbClose').onclick = closeLeaderboard;
      document.getElementById('lbPrev').onclick = ()=>{ page--; renderLB(); };
      document.getElementById('lbNext').onclick = ()=>{ page++; renderLB(); };
  btnLeaderboard.onclick = openLeaderboard;

      // Admin: click brand to clear leaderboard + device state (also clears verse/quote binding locally)
      document.getElementById('brand').onclick = async () => {
        const ok = confirm('確定要清除排行榜與所有裝置的遊戲紀錄嗎？（同時清除本機經文/語錄裝置綁定）');
        if (!ok) return;
        try {
          if (window.SUPABASE_ADMIN_CLEAR_URL) {
            let token = window.SUPABASE_ADMIN_TOKEN || '';
            if (!token) {
              token = prompt('請輸入管理密鑰（Edge Function 將驗證 x-admin-token）', '');
            }
            const res = await fetch(window.SUPABASE_ADMIN_CLEAR_URL, {
              method: 'POST',
              headers: {
                'content-type': 'application/json',
                // Supabase Edge Functions 通常需要 Authorization Bearer（若 verify_jwt 開啟）
                ...(window.SUPABASE_ANON_KEY ? { 'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}` } : {}),
                ...(token ? { 'x-admin-token': token } : {}),
              },
              body: JSON.stringify({ resetAll: true }),
            });
            if (!res.ok) throw new Error('clear failed');
            // 也清除此裝置的測驗與經文/語錄綁定
            localStorage.removeItem('rs_player_name_v1');
            localStorage.removeItem('rs_quiz_completed_v1');
            localStorage.removeItem('rs_quiz_result_v1');
            localStorage.removeItem('rs_device_key_v2');
            localStorage.removeItem('rs_bind_code_v1');
            alert('已請求清除排行榜，並清除此裝置的綁定與測驗紀錄。');
          } else {
            // Local-only clear: remove quiz LS keys on this device + verse/quote device binds
            localStorage.removeItem('rs_player_name_v1');
            localStorage.removeItem('rs_quiz_completed_v1');
            localStorage.removeItem('rs_quiz_result_v1');
            localStorage.removeItem('rs_device_key_v2');
            localStorage.removeItem('rs_bind_code_v1');
            alert('已清除此裝置的遊戲與裝置綁定。若要清除雲端排行榜，請設定後端 Function。');
          }
        } catch (e) {
          alert('清除失敗，請稍後再試。');
        }
      };

      // First render
  applyMode();
  });
    </script>

    <div id="modalBackdrop" class="modal-backdrop">
      <div class="modal">
        <header>
          <h3>排行榜</h3>
          <button id="lbClose" class="close-btn" type="button">關閉</button>
        </header>
        <div class="content">
          <div class="columns">
            <div id="lbCol1"></div>
            <div id="lbCol2"></div>
            <div id="lbCol3"></div>
          </div>
        </div>
        <div class="footer">
          <span id="lbPage" style="margin-right:auto"></span>
          <button id="lbPrev" class="close-btn" type="button">上一頁</button>
          <button id="lbNext" class="close-btn" type="button">下一頁</button>
        </div>
      </div>
    </div>
  </body>
</html>
